{% extends "base.html" %}
{% block title %}Gestión de Publicadores{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.14.0-beta3/css/bootstrap-select.min.css">
<style>
    /* Estilos para el menú de selección múltiple en tema oscuro */
    .bootstrap-select .dropdown-toggle { background-color: #21262d !important; color: #e6edf3 !important; border-color: #30363d !important; }
    .bootstrap-select .dropdown-menu { background-color: #161b22; }
    .bootstrap-select .dropdown-item { color: #e6edf3; }
    .bootstrap-select .dropdown-item.active, .bootstrap-select .dropdown-item:active { background-color: #2f81f7; }
</style>
{% endblock %}

{% block content %}
<h2 class="section-title">Registro de Publicadores</h2>
<div class="row">
    <div class="col-lg-6">
        <form action="{{ url_for('admin.add_user') }}" method="POST">
            <div class="card-floating">
                <h5 class="card-title"><i class="bi bi-person-lines-fill"></i> Datos Personales</h5>
                <div class="row g-3">
                    <div class="col-12"><label class="form-label">Nombre Completo</label><input type="text" name="nombre_completo" class="form-control" required></div>
                    <div class="col-12"><label class="form-label">Teléfono</label><input type="tel" name="telefono" class="form-control"></div>
                    <div class="col-6"><label class="form-label">Fecha de Nacimiento</label><input type="date" name="fecha_nacimiento" class="form-control"></div>
                    <div class="col-6"><label class="form-label">Fecha de Bautismo</label><input type="date" name="fecha_bautismo" class="form-control"></div>
                </div>
            </div>
            <div class="card-floating">
                <h5 class="card-title"><i class="bi bi-briefcase-fill"></i> Asignaciones</h5>
                 <div class="row g-3">
                    <div class="col-12"><label class="form-label">Congregación</label><select name="congregacion_id" class="form-select"><option value="">-- Sin asignar --</option>{% for c in congregaciones %}<option value="{{ c.id }}">{{ c.nombre }}</option>{% endfor %}</select></div>
                    <div class="col-12"><label class="form-label">Privilegios</label><select name="privilegios" class="form-control selectpicker" multiple data-live-search="true" title="-- Seleccionar --">{% for p in privilegios %}<option value="{{ p.id }}">{{ p.nombre }}</option>{% endfor %}</select></div>
                </div>
            </div>
             <div class="card-floating">
                <h5 class="card-title text-warning"><i class="bi bi-shield-lock-fill"></i> Acceso a la App (Opcional)</h5>
                 <div class="row g-3">
                    <div class="col-6"><label class="form-label">Usuario (Login)</label><input type="text" name="username" class="form-control"></div>
                    <div class="col-6"><label class="form-label">Contraseña</label><input type="password" name="password" class="form-control"></div>
                    <div class="col-6"><label class="form-label">Email</label><input type="email" name="email" class="form-control"></div>
                    <div class="col-6"><label class="form-label">Rol en la App</label><select name="role_id" class="form-select"><option value="">-- Sin acceso --</option>{% for role in roles %}<option value="{{ role.id }}">{{ role.name.capitalize() }}</option>{% endfor %}</select></div>
                </div>
            </div>
            <div class="text-end"><button type="submit" class="btn btn-primary btn-lg px-5">Añadir</button></div>
        </form>
    </div>

    <div class="col-lg-6">
        <div class="card-floating">
            <h5 class="card-title"><i class="bi bi-people-fill"></i> Lista de Publicadores</h5>
            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                <table class="table table-hover">
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>
                                <strong class="text-light">{{ user.nombre_completo }}</strong>
                                <br><small class="text-muted">{{ user.username }}</small>
                            </td>
                            <td class="text-end">
                                <a href="{{ url_for('admin.edit_user', user_id=user.id) }}" class="btn btn-sm btn-outline-warning" title="Editar"><i class="bi bi-pencil-fill"></i></a>
                                <form action="{{ url_for('admin.delete_user', user_id=user.id) }}" method="POST" class="d-inline" onsubmit="return confirm('¿Estás seguro?');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Eliminar"><i class="bi bi-trash-fill"></i></button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <!-- NUEVO: Card para actualizar la base de datos -->
        <div class="card-floating mb-4">
            <h5 class="card-title"><i class="bi bi-cloud-upload-fill"></i> Actualizar Base de Datos</h5>
            <form action="{{ url_for('admin.upload_db') }}" method="POST" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="db_file" class="form-label">Arrastra y suelta un archivo (.xlsx, .csv) o haz clic para seleccionar.</label>
                    <input class="form-control" type="file" name="db_file" id="db_file" required>
                </div>
                <button type="submit" class="btn btn-primary">Subir y Actualizar</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.14.0-beta3/js/bootstrap-select.min.js"></script>
<script>
    $('.selectpicker').selectpicker();
</script>
{% endblock %}